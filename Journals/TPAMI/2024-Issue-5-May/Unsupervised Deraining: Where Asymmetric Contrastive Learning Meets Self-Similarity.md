# 题目：[Unsupervised Deraining: Where Asymmetric Contrastive Learning Meets Self-Similarity](https://ieeexplore.ieee.org/document/10269093/) 
## 无监督去雨：非对称对比学习与自相似性相遇  
**作者：Yi Chang, Yun Guo, Yuntong Ye, Changfeng Yu, Lin Zhu, Xile Zhao, Luxin Yan, Yonghong Tian** 

**源码链接：** https://owuchangyuo.github.io
****  

# 摘要  
大多数现有的基于学习的去雨方法都是在合成的雨-清洁对上进行有监督训练的。合成雨与真实雨之间的领域差距使它们在复杂的真实雨场景中的泛化能力降低。此外，现有方法主要独立利用图像或雨层的属性，很少有方法考虑它们之间的相互排斥关系。为了解决这一困境，我们探索了每层内部的内在自相似性以及两层之间的相互排斥性，并提出了一种无监督的非局部对比学习（NLCL）去雨方法。非局部自相似性图像块作为正样本被紧密地拉在一起，而雨块作为负样本则被显著地推开，反之亦然。一方面，每层正/负样本内部的内在自相似性知识有助于我们发现更紧凑的表示；另一方面，两层之间的相互排斥属性丰富了区分性分解。因此，每层内部的自我相似性（相似性）和两层之间的外部排他关系（差异性）作为通用图像先验，共同促进我们无监督地区分雨和清洁图像。我们进一步发现，非局部图像块的内在维度通常高于雨块的维度。这一洞见激励我们设计了一种非对称对比损失，精确地模拟了两层的紧凑性差异，从而提高了区分性分解。此外，认识到现有真实雨数据集的质量有限，这些数据集通常是小规模的或从互联网上获得的，我们收集了一个大规模的真实数据集，该数据集包含了在各种下雨天气下捕获的高分辨率雨图。在不同真实雨数据集上进行的广泛实验表明，所提出的方法在真实去雨方面取得了最先进的性能。

# 关键词  
对比学习，图像去雨，非局部，无监督学习。

# Ⅰ. 引言  
高级计算机视觉任务，如图像分割[7]和目标检测[52]，在近年来取得了显著进展。不幸的是，它们在下雨天气下的性能会受到影响，导致性能下降[2]、[34]、[43]。为了减轻雨的影响，提出了许多全监督去雨方法[20]、[88]、[98]。尽管它们在模拟雨上取得了良好的结果，但由于简化的合成雨和复杂的真实雨之间的领域差距，它们通常难以很好地泛化到真实雨中[93]。

为了处理复杂的真实世界雨天图像，最初提出了基于优化的方法，这些方法结合了手工制作的先验知识，如稀疏编码[54]、低秩[5]和高斯混合模型[47]。然而，这些手工制作的先验知识在表示能力上是有限的，特别是对于高度复杂和多样化的雨天场景。为了纠正这个弱点，基于学习的CNN方法[20]、[42]、[88]取得了很大进展。研究人员从监督学习方法开始，通过使用复杂的模型（如加性模型[37]、屏幕混合模型[54]、大雨模型[88]、综合雨模型[30]、渲染模型[27]和学习到的雨模型[57]、[72]、[93]等）尽可能真实地模拟雨。

然而，真实雨受到各种因素影响，这些因素无法全面考虑。雨的外观与相机曝光时间（长度）、降雨量（密度）、雨滴大小（宽度）、风向（角度）和距离（雾/遮挡）等因素密切相关。在图1中，我们展示了从我们收集的真实雨图像中捕获的雨的代表性示例。真实雨不仅包括相对容易模拟的雨条纹，还表现出复杂的遮挡和雾化伪影。遮挡和雾化与场景深度强烈相关，这使得它们难以准确模拟。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/b4d03aabbcca4bb58304995b5863ac64.png#pic_center" width="70%" />
</div>

因此，合成模型和真实退化之间存在固有的领域差距，这限制了监督方法对真实雨场景的泛化能力。为了说明这个问题，我们在图2中提供了由代表性的监督方法JORDER-E[87]在真实雨图像上获得的去雨结果。尽管JORDER-E在合成雨上取得了非常令人印象深刻的结果，但在处理复杂和多样化的真实雨时效果不佳。在图2(b)中，可以清楚地观察到过度平滑现象，主要是由于领域差距。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/be4a9048543a4d72a060b7d2a82c6307.png#pic_center" width="70%" />
</div>

随后，提出了半监督去雨方法，以增强对真实雨去除的鲁棒性[32]、[53]、[78]、[80]、[92]、[93]。这些方法利用模拟标签进行初始化，并利用未标记的真实雨进行泛化。然而，它们的表现仍然依赖于减轻模拟和真实雨图像之间的分布差距。当分布显著不同时，SSIP[78]的半监督去雨结果可能不太令人满意，如图2(c)所示。无监督方法已经引起了对真实雨去除的关注，主要是基于CycleGAN的无配对图像翻译方法[14]、[35]、[80]、[101]和基于优化模型的深度先验网络[96]。图3总结了单图像去雨方法的发展。以前的方法主要关注图像或雨层的属性，而没有充分考虑它们之间的相互排斥关系。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/c3185d3977f04c2d8b3b830bcd89ea12.png#pic_center" width="70%" />
</div>

为了克服这些问题，我们将图像去雨问题表述为一种新颖的非局部对比分解框架。目标是将雨图像分解为两个可区分的层：图4中的清洁图像层和雨层。一方面，我们不仅利用图像和雨层内部的非局部自相似性属性，这有助于我们为每层学习紧凑的表示；另一方面，我们模拟了两层之间的相互排斥关系，丰富了区分性表示。通过利用每层内部的自我相似性以及两层之间的外部排他关系，我们可以有效地区分雨水和干净图像，而无需监督。值得注意的是，我们将图像和雨层同等对待，作为正样本和负样本，并提出了双向对称对比学习方法以实现更好的分解。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/2e269b1561414e79bb33717a4cf0a440.png#pic_center" width="70%" />
</div>

据我们所知，我们是第一个将非局部自相似性纳入对比学习以进行正/负样本采样的。提出的非局部采样的优势在于两点。首先，非局部自相似性采样策略将自然确保正样本和负样本的更紧凑的聚类，从而实现有效的区分。其次，这些正的非局部补丁是从真实图像中获取的，具有多样化和可变的信息，而不是人为生成的样本，因此为对比学习提供了更可靠的信息。此外，使用补丁而不是图像级样本显著增加了样本数量，从而改善了特征表示。值得一提的是，非局部采样策略不仅有利于正样本，也有利于负样本。此外，我们提供了设计适合对比学习的高效编码器的指导。

这项工作是我们在CVPR 2022[94]早期出版物的扩展，有三个主要改进。首先，我们进一步分析了图像和雨非局部聚类的内在维度差异。与之前版本中我们将图像和雨样本平等对待的分解不同，我们现在设计了一种非对称对比损失，以精确捕捉两层的紧凑性差异，从而实现改进的区分性分解。其次，我们通过实地收集创建了一个大规模的高质量真实雨图像数据集，该数据集具有多样化的雨外观。这很重要，因为现有的真实雨数据集通常质量较差或场景覆盖有限，因为它们来自互联网。第三，我们进行了更多的定性和定量实验，包括评估非局部采样的好处和对下游检测任务的推广。我们证明了ANLCL是一个通用先验，可以应用于其他恶劣天气任务，并且可以集成到现有方法中，取得足够的改进。总的来说，我们的贡献可以总结如下：
- 我们提出了一种非监督非局部对比学习（NLCL）去噪方法，该方法在对比分解框架内形成单图像去雨。该方法同时探索了每一层内部的内在相似性和两层之间的相互排斥性。值得注意的是，NLCL首次明确地考虑了学习网络中雨水和图像之间的排他性关系。
- 我们在对比学习和非局部自相似性之间建立了联系。与传统的实例/图像级采样不同，我们证明了非局部补丁级采样策略自然地赋予正/负样本更紧凑和不歧视的表示，以实现更好的分解。
- 此外，我们还为设计有效的编码器以更好地嵌入提供了指导。Wediscover在图像和降雨空间内的一个不对称性质：非局部图像斑块的内在维数通常高于降雨斑块的内在维度。为了利用这种不对称性，我们通过设计一个不对称的对比损失来捕捉这种差异，将对称NLCL扩展到不对称版本。
- 我们展示了这种不对称性质如何允许捕捉维度差异，并改进判别表示以更好地分解。我们贡献了一个大规模的高质量真实降雨图像数据集，该数据集收集了具有丰富交通元素注释的各种降雨天气城市道路。该数据集将作为一个有价值的试验台，特别是对于无监督的去噪方法。我们在合成和真实世界的降雨数据集上进行了广泛的实验，并表明ANLCLout在真实图像去噪方面的性能避免了现有方法的不足。

# III. 现场采集真实雨数据集

数据集在深度学习时代扮演着重要的角色。我们在表I中总结了现有的典型合成雨和真实雨数据集。大多数现有的数据集都是基于合成的。Nayar和Garg[23]、[24]提出了第一个工作，对真实雨的外观进行了几何和光度分析。基于光度模型，Fu等人[21]使用Photoshop模仿了雨成像过程。随后，Yang等人[88]和Hu等人[30]将焦外遮挡、远距离雾化效应和近距离雨遮挡纳入了一个综合雨模型。最近，Tremblay等人[66]通过结合物理粒子模拟器和雨光度建模，提出了一种可控的物理基础渲染（PRB）方法，进行了更现实的雨模拟，其中考虑了深度和照明，以获得更真实的降雨。这些合成模型在一定程度上促进了该领域的发展。尽管这些复杂的合成模型可以模拟雨的某些效果，但它们仍然面临着合成雨和真实雨之间域移位的挑战。真实雨数据集在近年来开始出现，我们描述了所提出的雨数据集，并从以下三个方面与现有数据集进行了比较。

## 采集与分辨率

现有的真实雨数据集大多数是从互联网上收集的，包括来自电视/电影、卡通/艺术和监控视频的雨图像。这些图像的分辨率差异很大，从6000\*3500到250\*180不等。值得注意的是，大多数从互联网收集的雨图像尺寸相对较小。我们在表I中报告了每个数据集的平均分辨率。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/ef8571b4d6964364bd174cac194bc0ea.png#pic_center" width="70%" />
</div>

请注意，SPA-Data没有报告原始视频的大小，我们列出了裁剪大小512\*512。可以观察到，真实数据集的分辨率通常小于720p。在这项工作中，我们使用Sony ILCE-6400相机在下雨天气下收集了真实雨图像。我们经验性地将快门速度设置在[1/160, 1/60]之间，光圈为f/5.6，焦距为50毫米。空间分辨率一致为4240\*2400，略大于标准4K（3840*2160），这为背景和雨提供了更详细的信息。

## 格式与数量

真实雨数据集的收集是困难的，因为它严重依赖于高度随机的降水。此外，雨可能对电子设备有害，使数据收集不便，甚至可能造成损坏。这些因素导致以前数据集中雨图像的数量相对较少。值得注意的是，在这项工作中，我们一致报告了每个数据集的来源数量，以便进行公平比较。我们没有报告如空间块裁剪或时间帧提取等增强数量的方法。在表I中，合成雨数据集的图像/视频数量明显大于真实雨数据集，因为生成合成数据的成本较低。构建真实雨数据集有两种常见格式：图像和视频。视频剪辑的数量通常很小，例如RIS中的154个，SPA-Data中的170个，PairedRain中的101个，以及SSID中的180个。然而，视频剪辑可以进一步提取为图像帧，尽管帧之间存在时间冗余。在这项工作中，我们收集了一个相对较大的数据集，包含4000张高分辨率的真实雨图像，涵盖了多样的场景和不同的雨模式。

## 亮点与局限性

合成雨数据集的优势在于可以可控地生成多样化的雨模式，并提供大量的样本。此外，合成数据集可以轻松提供成对的清洁和降级图像。这些大规模的成对合成数据集非常适合监督学习。然而，真实雨要复杂得多，导致域移位，使得在合成数据上训练的模型对真实雨的鲁棒性较差。因此，已经提出了真实雨数据集以推进真实雨去除领域的发展。SPA-Data[73]和PairedRain[1]旨在从视频中构建真实雨和清洁成对图像，为单图像真实雨去除提供了新的途径。

现有的真实数据集大多从互联网下载，存在几个限制。首先，这些下载的真实雨数据集在流式传输过程中意外地被压缩[1]、[31]、[44]。压缩的视频一方面会导致块状伪影，另一方面会削弱雨的特征。第二个问题是互联网视频中的意外水印。这些众多的水印[1]、[73]可能会导致训练过程中的学习偏差。更糟糕的是，一些真实数据集没有被很好地清洗，可能包含假图像，如卡通或肖像。第三个问题是数量和场景有限，通常少于1000个，这可能无法充分利用深度学习网络的强大表示能力。最后但同样重要的是，大多数真实数据集主要是为低级图像去雨设计的，而不是像检测这样的下游任务，除了RIS[44]。这些数据集没有面对特定应用，如典型的驾驶或监控，这限制了它们的进一步应用。

在这项工作中，我们提出了现场采集真实雨（FCRealRain）数据集，它由具有多样化雨外观的高质量图像组成。重要的是，FCRealRain专注于驾驶场景，结合了街道上的丰富对象。我们为六种典型类别提供了边界框注释：人、汽车、公共汽车、摩托车、交通灯和交通标志。因此，下游的检测可以进一步用于验证图像去雨算法的有效性。值得注意的是，大多数现有的真实数据集只包含真实雨图像而没有相应的清洁真实图像，包括FCRealRain。

# IV. 非对称非局部对比分解用于图像去雨

## A. 对比图像分解框架

给定一张雨图像  $O$ ，我们的目标是将雨图像分解为一个干净的背景层 $B$ 和一个雨层 $R$ 。退化过程可以被公式化为：

$$ 
O = B + R. 
$$  

因此，图像去雨任务可以被公式化为一个不适定的逆问题，具有以下优化函数：

$$ 
L_{decom} = ||B + R − O||^2_F + \delta Pb(B) + \lambda Pr(R), 
$$  

其中第一项是自洽数据保真度，$Pb$ 和 $Pr$ 分别表示干净图像和雨层的先验知识。由于雨条纹在空间上的稀疏性，我们通过 $L1$ 约束对雨层进行正则化：$Pr(R) = ||R||_1$，有利于具有大不连续性的雨条纹。另一方面，对于干净图像，我们采用对抗性损失 [25] 来学习与雨图像不同的分布映射：

$$ 
Pb(B) = E_B [logD(B)] + E_O [log(1 − D(G_B(O)))] , 
$$  

其中 $D$ 是鉴别器， $G_B$ 是干净图像的生成器。所提出的基于分解的架构如图 4(a) 所示，由两个分支组成，分别恢复背景 $G_B$  和提取雨 $G_R$。为了优化解耦的组件，我们在分解框架中引入了一个无监督损失。这使我们能够结合模型驱动优化方法的泛化能力和数据驱动学习网络的表示能力。

大多数现有的恢复方法都遵循（2）中的分解框架，使用不同的手工制作 [47] 或学习到的先验 [96]，其中他们只单独考虑干净图像或雨层。也就是说，（2）主要关注信号本身的统计属性建模。然而，它忽略了干净图像 $B$、雨层 $R$ 和观测图像 $O$ 之间的关系。在这项工作中，我们认为这些组件之间的对比关系可以进一步帮助它们相互区分。因此，我们引入了对比学习来模拟不同组件之间的关系，以实现更好的分解。整体目标函数包括分解约束和对比损失，被公式化为：

$$ 
L_{overall} = L_{decom} + L_{contrastive}(B, R, O). 
$$   

非对称非局部对比学习的动机：对比学习在低级图像去雾[81]和去雨[12]中已经初步研究。现有方法简单地将干净图像视为正样本，将降级的雨/雾图像视为负样本。退化与干净背景紧密纠缠在负样本中，这使得学习特征表示的区分性降低。最重要的是，图像背景总是比雨图案复杂得多。因此，对于复杂图像区域，轻微的雨不可避免地会被图像背景纹理信号淹没。在这种情况下，对于对比学习编码器来说，区分干净图像和雨图像极其困难，导致处理样本时出现错误，即过度平滑或残留结果，如图 4\(c\) 所示。自然而然，区分雨和图像图案（外观差异很大）比区分雨图像和干净图像（内容相似且纠缠）要容易得多。

其次，现有去雨/去雾方法中的对比学习样本总是图像级别的[12]、[14]、[81]。请注意，雨在整个图像中分布稀疏。雨的信息量远少于图像内容。如果我们将整个图像作为对比学习样本，编码器很可能会重点关注图像内容。特别是在轻雨/薄雾条件下，退化难以观察，这将导致学习雨图案的丰富表示非常困难，使得雨和图像的区分性降低。在这项工作中，我们认为采用局部块作为样本也是必要的。采样对象、采样尺度和采样策略是对比学习的关键，这将极大地决定图像去雨结果。

在图 4(d) 中，我们展示了我们非局部对比学习的概念图。与以前的方法相比，所提出的方法将估计的干净图像和雨作为正/负样本，反之亦然。解耦的图像和雨将显著降低学习难度，因为雨层和图像层具有明显不同的特征。而且，块级采样可以大大增加样本数量，有利于更好的特征学习。此外，我们利用每层内部的固有非局部自相似性，例如相似块采样策略将进一步提高对比样本的紧凑性。总体而言，解耦的样本选择和非局部采样策略将自然扩大类间样本的差异，同时增强类内样本的紧凑性，以更好地分解雨和图像。

在图 4(e) 中，我们进一步将 NLCL 扩展到其非对称版本。NLCL 在非局部对比分解中同等对待雨和图像层。然而，这并不完全正确，因为图像块包含多样化的模式，如复杂的纹理和锐利的边缘，而雨块要简单得多，具有线状条纹或遮挡。图像块空间可能位于更高维的流形上，而雨块空间可能位于低维流形上（第 IV-C 节）。这一直观的观察启发我们将雨和图像块之间的紧凑性差异线索纳入对比分解，以便更好地区分雨和图像。

所提出方法的总体架构如图 5(a) 所示。接下来，我们将首先描述我们如何构建每个组件 B、R 和 O 之间的对比关系（第 IV-B）。最后，我们将介绍正/负采样策略（第 IV-D）并详细设计编码器（第 IV-E）。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/59e3bdd8b17341bca428ace00cb19518.png#pic_center" width="70%" />
</div>

## B. 联合层和位置对比

在本部分，我们介绍了如何通过联合层对比和位置对比来优化图像去雨过程。

### 层次对比度

首先，干净图像 $B$ 和雨层 $R$ 具有显著的不同特征，其中雨层通常表现为简单且具有方向性的线状图案，而自然图像则包含复杂但有意义的结构，如边缘和纹理。这两者之间的差异性可以通过对比学习（Contrastive Learning, CL）作为负样本对进行建模。同时，考虑到同一图像内的块具有相似性，我们可以将它们作为正样本。具体的采样策略和编码器将在后续小节中讨论。在图 5(b) 中，我们考虑图像和雨层作为两个等同对称的组成部分。因此，我们提出了双向对称层对比学习，其目标是将图像层和雨层作为正负样本进行区分，公式化表示如下：

$$
L_{LayerCon} = - \frac{1}{N_B} \sum_{i=1}^{N_B} \sum_{k=1}^{N_B} \exp\left(\frac{f_{B_i} \cdot f_{B_k}}{\tau}\right) - \frac{1}{N_R} \sum_{j=1}^{N_R} \sum_{m=1}^{N_R} \exp\left(\frac{f_{R_j} \cdot f_{R_m}}{\tau}\right) - \frac{1}{N_B} \sum_{i=1}^{N_B} \sum_{j=1}^{N_R} \exp\left(\frac{f_{R_j} \cdot f_{B_i}}{\tau}\right),
$$ 

其中 $f_{B_i} = E_D(p_{B_i})$, $f_{R_j} = E_D(p_{R_j})$ , $\tau$ 表示尺度温度参数。第一项是图像正样本和雨负样本层对比，第二项是雨正样本和图像负样本层对比。通过将图像和雨层视为两个等同的组成部分，双向对称层对比学习有助于将一个层推向另一方，同时使每个层更加紧密地聚集。 $E_D$ 是对比网络的编码器。特征 $f_{B_k}$ 和 $f_{R_m}$ 分别从图像块 $p_{B_i}$ 和雨块 $p_{R_j}$ 的非局部补丁 $p_{B_k}$ 和 $p_{R_m}$ 中提取。 $N_B$ 和 $N_R$ 分别表示正样本和负样本的数量。

 ### 位置对比
 
 其次，我们可以观察到干净图像 $B$ 和观测图像 $O$ 在视觉上非常接近，因为雨条纹 $R$ 比 $B$ 简单得多。 $B$ 和 $O$ 中相同位置的块，作为同一视图，可以很好地作为正样本进行建模。因此，我们将不同位置的块设置为负样本。在图 5(c) 中，对于位置对比，由于位置对应是一一对应的，因此应该只有一个正样本。图像生成器 $E_{GB}$ 的编码器用于提取块特征，表示为 $v_{O_i} = E_{GB}(p_{O_i})$ 和 $v_{B_i} = E_{GB}(p_{B_i})$ 。因此，位置对比损失被公式化为：

$$
L_{LocCon} = \sum_{i=1}^{N} \frac{\exp(v_{O_i} \cdot v_{B_i} / \tau)}{\sum_{j=1}^{N} \exp(v_{O_j} \cdot v_{B_i} / \tau)},
$$

其中 $N$ 是负样本的数量。位置对比学习约束了恢复的背景块 $p_{B_i}$ 在位置 $i$ 上与对应的输入块 $p_{O_i}$ 相关联（正样本），与其它随机块 $p_{O_j}$ 相比较，以保留图像内容。总体而言，层对比学习旨在从图像层中去除雨，而位置对比学习旨在在去除雨的过程中保留图像内容。这两种对比损失相互竞争，以获得平衡。

## C. 非对称层对比

尽管联合层和位置对比通过内在特征差异分解了图像和雨层，但每层的紧凑性差异并未被完全考虑。在这项工作中，我们提出将对称对比分解扩展到非对称对比分解。具体来说，我们发现图像空间的维度通常高于雨空间，这意味着大多数图像块包含更多样化和复杂的结构和模式。换句话说，雨块的紧凑性应该比图像块的紧凑性更紧密。为了利用这一细粒度的差异属性，我们提出了非对称对比分解，通过考虑图像和雨块之间的紧凑性差异，进一步改善了区分性表示。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/8af6735c3fb84558974a7c5505fe39db.png#pic_center" width="70%" />
</div>

我们选择典型的16*16块从干净图像层和雨层中，如图6(a)所示，主要包括六类：图像的平滑、纹理、边缘区域，以及雨的条纹和遮挡区域。我们首先计算每个类别块的熵，并在图6(b)中进行比较。熵是通过定义 $-\sum(p \cdot \log_2(p))$ 来评估随机性（复杂度）的，其中 $p$ 是归一化直方图计数的概率。我们可以发现，图像的边缘和纹理块的熵通常高于雨的条纹和遮挡块。然而，对于图像的平滑块，现象相反，其熵甚至低于雨块。

我们还对每个类别的补丁集进行了奇异值分解（SVD）和 T-SNE 可视化，其中低秩曲线可以很好地反映每个类别补丁的相似性。在图 6(c) 中，我们展示了每个类别的 SVD 曲线略有不同。此外，每个类别的低秩性与熵成正比。也就是说，补丁越复杂（熵越高），补丁之间的相似性越低。在图 6(d) 中，我们执行 T-SNE 来可视化这些不同补丁的二维分布。

这激发了我们利用图像和雨之间的细粒度差异属性，通过非对称对比分解来更好地区分它们。为了实现这一点，我们引入了边际损失来正则化图像和雨块之间的距离：

$$
L_{Margin} = \sum_{i,j=1}^{N_R} \sum_{m,n=1}^{N_B} [ \epsilon + \eta ( || f_{R_i} - f_{R_j} ||^2 - || f_{B_m} - f_{B_n} ||^2 ) ]_+,
$$ 

其中 $[z]_+ = \max(z, 0)$ 表示标准铰链损失，$\epsilon$ 是预定义的边际，通常设置为 1。$\eta \in \{1, -1\}$ 用于指示采样图像块的熵是否大于采样雨块的熵。我们可以简单地预先计算非局部采样图像和雨块的熵，以确定 $\eta$ 的选择。边际损失的物理意义是使雨块之间的距离保持在图像块之间距离的较大边际之上。

为了与对称对比损失兼容，我们将边际损失（7）转换为非对称对比损失：

$$
L_{AsymCon} = - \frac{1}{N_R} \sum_{i=1}^{N_R} \sum_{j=1}^{N_R} \exp\left(\frac{f_{R_i} \cdot f_{R_j}}{\tau}\right) - \frac{\eta}{N_B} \sum_{m=1}^{N_B} \sum_{n=1}^{N_B} \exp\left(\frac{f_{B_m} \cdot f_{B_n}}{\tau}\right),
$$ 

其中（8）中的参数和函数与（5）中的含义相同。注意，对称对比损失（5）的目标是平等地最小化雨/像空间内的距离，同时增大雨和像空间之间的距离，而非对称对比损失（8）的目标是根据不同内容调节每个空间内的距离。非对称对比损失将进一步捕获细粒度的紧凑性差异，改进两层之间的区分性表示。

## D. 非局部采样策略

在对比学习中，负样本是通过学习到的表征进行区分的样本，而正样本则是高度相关并在学习到的表征中具有不变性的样本。以往的方法通常使用增强来构建单个实例的正样本，并随机采样作为负样本 [8]。值得注意的是，自相似性是一种通用且强大的先验知识。在本工作中，我们引入非局部自相似性来自动选择单个图像内的正负样本。我们采用块匹配 [4] 与 L2 欧几里得距离来度量图像空间中的不相似性/相似性：

$$
\text{Dist}(p_i, p_{iR}) = ||p_i - p_{i\Omega}||^2,
$$

其中 $p_i$ 是查询块， $p_{i\Omega}$ 是在支持集 $\Omega$ 中搜索的块。我们将最小的 top-k Dist() 作为相似块，而最大的 top-k Dist() 可以被视为不相似块。算法 1 提供了非局部正负采样策略的伪代码。一方面，具有相似结构的非局部采样将极大地减轻学习难度。另一方面，相似样本中的小扰动将进一步提高多样性。此外，从图像本身裁剪的块将提供更可靠的表征学习。非局部采样策略可以用于采样正样本和负样本。我们简要描述了我们如何以非常灵活的方式使用非局部采样。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/70d2ae5e94a64cda9e6ee6f3953b93f0.png#pic_center" width="70%" />
</div>

### 在层对比中的非局部采样

在层对比中，干净图像和雨条纹可以被视为两个不同的类别，它们具有类内相似性和类间不相似性。我们的原则是，正样本（B中的干净图像块）应尽可能地被拉近，负样本（R中的雨条纹块）也是如此，它们也可以被拉近。因此，我们在正负样本上都实施了非局部采样。

与单一正样本实例相比，多个非局部正样本将有助于我们改善特征表示。最近的研究还表明，如果适当采样（有监督标签 [38] 或多模态 [28]），来自多个实例的正样本可以改善表示。此外，非局部采样还可以额外建模样本之间的关系。

为了说明这一点，图 7 显示了不同的采样策略：随机、邻近和非局部。随机采样意味着我们随机选择整个图像中的块作为正样本。邻近采样表示正样本是从具有高相似度的周围块邻居中采样的。请注意，与非局部采样策略相比，非局部采样仍然基于非局部采样，并额外增加了不对称损失约束。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/ddf869c5e0ef41af9673a6a3f3cc0d30.png#pic_center" width="70%" />
</div>

在图 7(a)-(c)中，我们提供了图像块内部的距离、雨块内部的距离以及雨和图像块之间的距离。与随机采样或邻近采样相比，非局部正样本的距离迅速减小，并收敛在相对较低的水平，这表明自相似性逐渐被学习，并且块在恢复过程中更加相关。相反，雨和图像块之间的距离逐渐增大，这意味着两个组件逐渐解耦。这些结果令人信服地验证了所提出的非局部采样策略的优越性。其次，所提出的不对称损失可以进一步减少类内相似性和类间不相似性，优于非局部采样。这是因为不对称损失将适应性地学习每个簇的紧凑距离。此外，我们在图 7(d)和(e)中展示了非局部和其他采样的逐步去雨结果。随着训练周期的增加，雨水和图像逐渐解耦，而邻近采样会在图像中留下轻微的残余雨条纹。

### 在位置对比中的非局部采样

观测到的图像 O 和干净图像 B 非常相似。在位置对比中，目标是保留观测到的图像中的内容并移除雨条纹，这正是一个图像到图像的翻译任务。因此，我们遵循 CUT [59] 的做法，将 B 和 O 中相同位置的块设置为正样本，并使用大批量大小。以前的包括 CUT 在内的方法随机选择不同的块作为负样本。更合理的是，与正样本的差异越大，负样本就越容易。在困难负样本挖掘中已知，困难的负样本比容易的负样本更有效 [62]。top-k 最大的样本是最容易的负样本，因为它们与查询块最不相似。相反，top-k 最小的样本是最难的负样本，因为它们与查询块最相似，本质上难以区分。这激发了我们使用非局部采样策略构建负块。关于困难负样本挖掘的详细信息将在实验中讨论。

## E. 特征编码器的选择

在对比学习中，特征编码器的作用是将输入映射到一个低维特征表示空间，该空间便于测量正样本和负样本之间的距离。已经认识到，对于不同的对比学习任务，编码器的选择将极大地影响最终性能 [40]。在这项工作中，我们也证明了对于低级恢复任务，编码器的选择确实是任务依赖的，并且我们直观地和实验性地探索了层对比和位置对比的不同的编码器。

对于层对比，目标是区分雨条纹和干净图像，这类似于分类问题。也就是说，层对比的编码器应该提取关于类别信息的高层语义。鉴别器与层对比编码器相符合，它可以区分图像和非图像成分，包括雨条纹。至于位置对比，干净图像和观测到的雨图像非常相似，其中干净图像是雨图像中的主导成分。换句话说，位置对比的编码器应该很好地提取图像特征。图像生成器可以令人满意地实现这一目标。

为了验证我们的假设，图 8 可视化了由不同编码器编码的嵌入特征映射：图像生成器和鉴别器。第一行显示了由图像编码器提取的特征，第二行显示了由鉴别器编码器提取的特征。我们选择了两个不同的干净图像和两个不同的雨条纹作为示例。我们可以观察到，图像生成器能够有效地提取图像结构，而它不能从雨条纹中提取任何有用的信息。相反，由鉴别器编码器提取的特征中可以清晰地观察到线状的雨条纹和图像结构。鉴别器专注于图像和非图像因素的可区分特征，以执行分类任务，这更适合层对比学习任务。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/3868b17ad8f24cb1ac8dcc544862dac5.png#pic_center" width="70%" />
</div>

## F. 实施细节

所提出的ANLCL方法使我们能够在无监督的条件下区分雨水和干净图像。然而，如果使用随机初始化训练ANLCL模型，可能无法将图像层与雨层分离。为了解决这个问题，我们采用了两阶段的预训练和微调训练策略[96]。首先，我们利用基于合成数据集的监督去雨知识作为两个生成器的初始化，并在没有CL损失的情况下训练生成器和鉴别器。其次，我们使用公式(4)中的总体损失训练整个ANLCL模型。由于CL编码器与鉴别器相关联，直到获得训练良好的鉴别器，对比学习损失才会起作用。

我们为图像和雨特征提取使用相同的ResNet架构[36]。PatchGAN[33]被用作鉴别器。我们首先计算图像空间中的top-k非局部块，然后从编码器获取多层特征[59]，最后通过两层具有256单元的MLP将非局部特征嵌入到特征空间中。采样数量N、NB和NR分别设置为256、8、256。每个损失的平衡权重λ、δ、μ、σ和γ分别设置为0.1、1、1、1、0.01。由于FCRealRain的高分辨率，我们首先将原始图像缩小4倍，然后随机裁剪256×256块进行训练。我们采用Adam优化器，学习率为0.0001，在四个RTX 3090 GPU上以批量大小4进行网络训练。

编码器的更新遵循MoCo[29]的设置，使用动量值为0.99和温度为0.77。我们的对比学习与经典的MoCo略有不同，其中有两个不同的正负流。在非局部对比学习中，图像和雨在分解框架内是对称的。因此，我们稍微修改了MoCo以适应我们的NLCL。具体来说，层对比中的特征编码器设置为图像鉴别器。请注意，在NLCL中，正负流共享相同的编码器参数。然后，我们根据鉴别器更新两个流的编码器，采用动量更新策略。类似的设置也应用于位置对比与图像生成器。

# V. 实验结果

## A. 数据集和实验设置

我们在合成数据集RainCityscapes [30]、真实数据集SPA [73]以及提出的FCRealRain上进行实验。为了模拟真实情况，我们将RainCityscapes分为1400个用于训练和175个用于测试。请注意，我们无法访问地面真实情况，只能以无监督的方式进行学习。对于真实的SPA数据集，我们从SPA获取了2000张雨景图像用于训练，以及200张雨景图像用于测试。为了公平比较，我们选择了包括基于优化的DSC [54]、基于CNN的DIP [67]、基于GAN的CycleGAN [102]和DerainCycleGAN [80]、基于对比学习的CUT [59]和DCD-GAN [12]、基于优化驱动的深度CNN [96]等无监督方法进行比较。此外，我们在真实雨景图像上与最先进的监督方法JORDER-E [87]和AECRNet [81]进行了比较。我们采用全参考PSNR/SSIM和无参考自然图像质量评估器(NIQE) [56]来评估去雨性能。此外，我们采用平均精度均值(mAP)来评估下游目标检测。

## B. 与最先进方法的比较

在表II中，我们报告了在RainCityscape和SPA上的定量结果。这些数据集主要包含具有不同视觉外观的雨条纹，没有重雨图像中的遮蔽。定量结果表明，NLCL大多优于竞争方法，这验证了所提出方法的有效性。此外，ANLCL进一步提高了结果，并实现了最先进的性能。我们强调，ANLCL并非专为雨条纹的定量指标设计。相反，我们的哲学是无监督地处理真实雨水。为了验证这一点，在图9中，我们在FCRealRain上与最先进的方法进行了比较，其中包含雨条纹和遮蔽。无监督方法在FCRealRain上进行训练和测试，而监督方法JORER-E和AECR-Net在成对的合成数据集上进行训练。所提出的ANLCL一致地实现了更令人愉悦的视觉结果，不仅去除了雨条纹，还去除了遮蔽伪影，同时更好地保留了图像结构。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/5e953d37df7e478987710c9e579e04b6.png#pic_center" width="70%" />
</div>

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/6e077b19b85d436db74a31fea80e9850.png#pic_center" width="70%" />
</div>

### C. 消融研究

非局部采样策略的有效性：在表III中，我们比较了对比学习中正负样本的不同采样策略，包括随机采样、邻近采样（8个最近邻块）和提出的非局部采样。这些实验都在层对比上进行。与随机采样相比，非局部采样对于正负样本都能明显改善恢复结果。也就是说，非局部采样有利于学习图像和雨条纹的相似性，从而确实减少了正负样本内部的方差，同时增大了它们之间的差异。邻近采样可以稍微改善结果，而非局部采样仍然获得最佳性能。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/6beefda29b044330821218eb311b2c77.png#pic_center" width="70%" />
</div>

不同特征编码器的选择：编码器对潜在特征空间的选择非常重要。在表IV中，我们测试了层对比和位置对比的不同的编码器。在第二和第三行中，我们将层和位置对比的编码器设置为相同的，即鉴别器和图像生成器。我们可以观察到，使用相同编码器的模型性能比所提出的方法差。也就是说，不同对比学习中的编码器应该根据其目的进行设置，正如我们在第IV节-E中解释的。在第四行中，我们进一步展示了编码器的层对比采用两个不同的编码器图像和雨生成器的结果。这表明，与雨生成器相比，图像生成器更适合于对比编码器。鉴别器作为层对比编码器，图像生成器作为位置对比编码器，取得了最佳结果。这个结果是相当合理的，因为鉴别器自然学习将图像与生成的图像（包括雨伪影）区分开来，而图像生成器则本质上捕获了不同的图像块内容。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/36291fa43eb5496e91e5ac5370a781fc.png#pic_center" width="70%" />
</div>

每个损失的贡献：在表V中，我们展示了每个损失对最终结果的贡献。LLocCon和LLayerCon旨在学习雨后-干净图像和雨-图像层之间的关系。我们可以观察到，这两种对比损失可以极大地改善去雨结果，自洽和对抗损失是我们模型的基线。L1稀疏损失可以略微改善性能。不对称对比损失LAsymCon进一步提高了结果。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/c233046635d748eea365c6690309d044.png#pic_center" width="70%" />
</div>

## D. 分析与讨论

### 层对比的有效性

在图10(b)中，我们执行了T-SNE来可视化带与不带层对比约束的分解图像和雨层的分布。没有层对比时，红菱形（图像）和红五角星（雨）的分布是发散的，并且它们相互混合，这意味着它们仍然无法区分。相反，当我们应用层对比时，绿色菱形（图像）和绿色五角星（雨）的分布变得集中并且可区分。基于层对比，我们提出的不对称对比进一步改善了区分表示。具体来说，蓝色菱形（图像）和蓝色五角星（雨）的分布被很好地解耦，并且与蓝色菱形（图像）相比，蓝色五角星（雨）的紧凑性明显增强。此外，在图10(a)和(c)中，我们可视化了几个典型的图像和雨块的分解结果。层对比可以逐渐促进雨和图像层之间的解耦。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/673218294a434af1a3615fbfd9052fe2.png#pic_center" width="70%" />
</div>

### 对雾和雪的泛化

ANLCL是一个通用的先验，用于图像分解，我们不依赖于特定的领域知识，而是利用每层内部的内在自相似性以及不同层之间的差异。在这里，我们证明了ANLCL可以很好地应用于其他典型的低级恢复任务：去雾和去雪。我们无监督地使用从互联网收集的真实数据对所提出的方法进行重新训练，并选择了最先进的方法进行公平比较：PSD [16]和DA-Dehazing [63]用于去雾，HDCWNet [11]和JSTARS [10]用于去雪。请注意，训练和测试图像都是真实的，没有地面真实情况。

在图11和图12中，我们展示了去雾和去雪的视觉和定量结果。从视觉结果来看，我们可以观察到ANLCL明显增强了对比度，自然外观，并在真实场景中移除了可观察的雪，同时保留了更好的细节。此外，就定量指标而言，与真实退化图像相比，去雾方法通常对结果有积极贡献，而去雪方法可能会带来负面影响。可能的原因是去雾方法可以在不损害图像内容的情况下一定程度上增强对比度，而去除雪的方法容易受到过度平滑和雪残留问题的影响，如图11和图12所示。ANLCL在不同任务中都获得了最好的定量结果，这进一步验证了所提出方法的有效性。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/890c638c61054d6e9f81790099f8baa5.png#pic_center" width="70%" />
</div>

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/ae57e8099b5c4d33b1de3c983400ddf6.png#pic_center" width="70%" />
</div>

### 自相似性块的可视化

非局部自相似性在无监督对比学习中起着关键作用。我们在图14中可视化了轻雨和重雨条件下查询关键块的前5个非局部正样本和负样本。可以观察到，正样本和负样本与查询关键块非常相似。与其他采样相比，这些自相似性块自然紧凑，这将显著有助于我们学习更具辨别性的表示。此外，值得注意的是，这些自相似性块是真实可靠的，并且有轻微的差异，而不是传统上具有固定变换的增强。这些相似但不同的块自然成为对比学习的理想样本。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/08737bac55374f2e8ef0b46993a8fab8.png#pic_center" width="70%" />
</div>

### 对现有方法的提升

ANLCL是一个通用的先验，可以自然地嵌入到现有方法中，包括监督和无监督方法。我们只需要在现有方法上强制施加层对比和不对称对比损失。嵌入的ANLCL损失易于嵌入且对推理友好，不会增加任何参数。

对于监督去雨，我们选择了最先进的PReNet [61]和RCDNet [71]作为示例。我们使用RainCityscapes数据集来验证ANLCL对监督去雨方法的提升性能。在表VI中，我们列出了基线、基线+ANLCL和增益的PSNR/SSIM性能。现有的监督去雨方法在嵌入ANLCL损失后获得了进一步的改进。对于无监督去雨，我们以无监督去雨方法UDGNet [96]为例。在图15中，没有ANLCL损失，尽管UDGNet能够很好地去除雨条纹，但图像结构已被意外地移除。UDGNet + ANLCL的结果要好得多，特别是对于结构保留，如文本，这进一步支持了ANLCL在辨别性图像和雨分解中的有效性。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/4a0c25a147ca400a8b461486fa539533.png#pic_center" width="70%" />
</div>

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/0b61e89b28d141ddadc3ac6ec7678546.png#pic_center" width="70%" />
</div>

### 对下游检测的促进

所提出的数据集包含了雨景图像目标检测评估的边界框注释。已经分析了，并非所有的图像去雨方法都有利于检测和跟踪 [2]。在表VII中，我们报告了使用YOLOv5对FCRealRain数据集的提及结果的平均精度均值(mAP)。值得注意的是，JORDER-E、CycleGAN、CUT、UDGNet将对检测结果产生负面影响。这是合理的，因为去雨过程中图像结构的损害超过了去雨的好处。相反，ANLCL一致地提高了所有类别的检测性能，除了人。例如，JORDER-E意外地过度平滑了图像细节，明显削弱了检测的区分特征。在图13中，去除雨水后，ANLCL可以进一步检测到摩托车，而其他竞争方法失败。此外，去雨后ANLCL的置信度得分也一致提高。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/cb3fea23388c46e0b6f06d648dc36b36.png#pic_center" width="70%" />
</div>

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/d954bb1eb7af4d839e38228e69093f37.png#pic_center" width="70%" />
</div>

### 不对称超参数η的影响

在不对称层对比学习中，自适应超参数η ∈ {1, −1} 用于指示采样图像块的熵是否大于或小于采样雨块的熵。如果图像的熵大于雨的熵，我们设置η = 1；反之，η = −1。在表VIII中，我们分析了η的不同设置：η = −1、η = 1和根据预先计算的熵动态选择 {−1, 1} 的影响。当固定η = −1，即雨块的熵大于图像块的熵时，去雨结果甚至不如没有不对称对比损失的NLCL。这是合理的，因为固定η = −1意外地违反了事实。相反，当固定η = 1，即雨块的熵小于图像块的熵时，去雨结果比NLCL和固定η = −1的ANLCL要好得多。这个结果很有意义，因为占主导地位的图像纹理和边缘块自然具有比雨块更高的熵。最后，当根据采样图像和雨块之间的实际情况动态选择η ∈ {1, −1} 时，去雨结果进一步改善，验证了不对称对比损失的有效性以及η的动态选择的有效性。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/793a9fbde1954b92a024fa7e4a9a77cf.png#pic_center" width="70%" />
</div>

### 查询数量的选择

我们对单个查询应用KNN搜索来进行非局部自相似性搜索。在表IX中，我们分析了查询数量对去雨性能的影响。随着查询数量的增加，无论是正样本（图像块）还是负样本（雨块），去雨性能可以逐步进一步改善。这个结果也是合理的，因为增加的查询数量可以增加对比训练的训练正负样本，这无疑增强了雨水和图像特征表示，从而实现更好的区分性分解。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/c2cc115165c24a3c9282b3b16700b827.png#pic_center" width="70%" />
</div>

### 非局部采样数量的选择

我们在表IX中展示了采样数量如何影响去雨结果。我们可以观察到，正样本（图像层）的最优采样数量一致是8，而负样本（雨层）的最优采样数量是256或512。这一发现适用于不同的查询数量。原因是雨水本质上具有相似的线状模式，因此可以找到更多的非局部相似块来促进学习，相比之下复杂图像块的多样性更大。此外，采样数量并不是越大越好，对于正样本图像块来说，因为图像块具有更多复杂多样的模式，这使得满足自相似性的需要变得困难。这就是为什么正样本的数量会少于负样本的数量。

### 位置对比中的困难负样本挖掘

在位置对比学习中，我们比较了三种负采样策略：容易的（top-k最大的）、困难的（top-k最小的）和随机的，如表X所示。首先，我们观察到困难负样本挖掘确实比容易的负样本更有效。这是合理的，如果对比模型有能力区分最困难的样本，那么它无疑会学习到更多区分性的表征。其次，有趣的是，容易和困难的采样都优于随机采样。根据常识，不同采样方式的性能按降序排列应该是困难的、随机的和容易的。然而，容易的采样的性能明显优于随机采样，并且非常接近困难采样。我们推测对比模型可能对结构化采样比随机采样更敏感。容易的和困难的采样都计算了查询和潜在样本之间的最小和最大距离。容易的样本和困难的样本具有内在的结构相关性，这将显著降低编码器学习的难度。这进一步验证了我们的自相似性采样的有效性。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/156fbb3bb8d44a84942b4ce318e68ee9.png#pic_center" width="70%" />
</div>

### 模型大小和运行时间

在推理中，所提出的ANLCL方法包含非常简单的9个ResNet块，我们没有使用非常复杂的架构。我们的目标是验证非局部对比损失对区分性图像和雨层分解的有效性。在表XI中，我们报告了竞争方法的模型大小和运行时间。我们可以观察到ANLCL的模型大小为2.6M，大大小于其他模型。此外，ANLCL的运行时间为0.01秒，比其他方法快得多，使其更适用。

<div align=center>
  <img src="https://img-blog.csdnimg.cn/direct/ac1149cb5bd54e2bb6ff9c390f3bdae8.png#pic_center" width="70%" />
</div>

## VI. 结论

在本文中，我们提出了一种新颖的非局部对比学习方法，用于处理真实场景中的图像去雨问题。该方法利用图像内部的强大自相似性属性。我们无监督的方法可以自动地将图像与雨迹分离，并具有良好的泛化能力，适用于不同的真实场景和任务。我们展示了我们的非局部采样策略可以用于学习正样本和负样本的有意义表示。特别是，我们提出的非局部采样策略为正负样本都提供了丰富、多样且结构化的真实表示。此外，我们提出了不对称层对比损失，该损失精确地模拟了两个层之间的紧凑性差异，从而实现更好的区分性分解。另外，我们还贡献了一个高质量的实地采集真实雨数据集，用于无监督的训练和测试。广泛的实验表明，ANLCL在真实雨景图像中实现了最先进的性能。
